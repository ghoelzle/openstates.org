language: python
dist: xenial
addons:
    postgresql: "11"
    apt:
        packages:
            - "postgresql-11-postgis-2.5"
sudo: false
python:
    - "3.6"
    - "3.7"
    - "3.8"
env:
  - DATABASE_URL="postgis://test:test@localhost/test"
jobs:
  allow_failures:
    - python: "3.8"
install: 
    - pip install poetry
    - poetry install
    - npm ci
    - npm run build
before_script:
    - psql -c "CREATE USER test with PASSWORD 'test' CREATEDB SUPERUSER;" -U postgres
    - psql -c "CREATE DATABASE test;" -U postgres
    - psql -c 'CREATE ROLE travis SUPERUSER LOGIN CREATEDB;' -U postgres
    - psql -c "CREATE EXTENSION postgis;" -U postgres -d test
    - cp config/database.yml.travis config/database.yml
before_install:
  - sudo apt-get update
  - sudo apt-get --yes remove postgresql\*
  - sudo apt-get install -y postgresql-11 postgresql-client-11
  - sudo cp /etc/postgresql/{9.6,11}/main/pg_hba.conf
  - sudo service postgresql restart 11  
before_script:
  - psql --version
script: 
    - poetry run pytest --ds=openstates.test_settings --reuse-db -v geo graphapi public v1 utils
    - poetry run flake8
notifications:
    email:
        - james@openstates.org
